<!DOCTYPE html>
<html>
<head>
    <title>Smart Road Intelligence - Command Center</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --bg: #0b0e14; --sidebar: #151921; --accent: #00d2ff; --danger: #ff4d4d; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 380px; background: var(--sidebar); display: flex; flex-direction: column; border-right: 1px solid #2d3436; z-index: 1000; }
        #map { flex-grow: 1; z-index: 1; }
        .header { padding: 20px; border-bottom: 1px solid #2d3436; background: rgba(0,0,0,0.2); }
        .nav-input { padding: 20px; }
        input { width: 65%; padding: 12px; background: #0b0e14; border: 1px solid var(--accent); color: white; border-radius: 4px; }
        button { padding: 12px; background: var(--accent); border: none; font-weight: bold; cursor: pointer; border-radius: 4px; color: #000; transition: 0.3s; }
        button:hover { background: #fff; }
        #log-container { flex-grow: 1; overflow-y: auto; padding: 15px; font-family: 'Courier New', monospace; font-size: 11px; color: #888; }
        .log-entry { margin-bottom: 10px; padding: 10px; border-left: 3px solid var(--accent); background: rgba(255,255,255,0.03); }
        .hazard-table { width: 100%; font-size: 10px; border-collapse: collapse; }
        .hazard-table th { text-align: left; color: var(--accent); padding-bottom: 5px; }
    </style>
</head>
<body>
    <div id="sidebar">
        <div class="header">
            <h2 style="margin:0; font-size: 22px; color: var(--accent);">PUNE V2V GRID</h2>
            <p style="font-size: 10px; opacity: 0.6;">NETWORK STATUS: <span style="color: #2ecc71;">ENCRYPTED ‚óè</span></p>
        </div>

        <div class="nav-input">
            <input type="text" id="dest" placeholder="Enter Pune Destination...">
            <button onclick="initiateNavigation()">GO</button>
        </div>

        <div id="log-container">
            <div class="log-entry">Waiting for Vehicle Telemetry...</div>
        </div>

        <div style="padding:15px; background: #0b0e14; border-top: 1px solid #2d3436;">
            <h4 style="margin:0 0 10px 0; font-size: 12px; color: var(--danger);">GLOBAL HAZARD REGISTRY</h4>
            <table class="hazard-table" id="h-table">
                <tr><th>VEHICLE_ID</th><th>LOCATION</th><th>STATUS</th></tr>
            </table>
        </div>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js"></script>

    <script>
        // Set Map to Pune
        const map = L.map('map', {zoomControl: false}).setView([18.5204, 73.8567], 14);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        let userCar = L.marker([18.5204, 73.8567], {
            icon: L.divIcon({className: 'car', html: '<div style="background:#f1c40f; width:18px; height:18px; border-radius:50%; border:2px solid #fff; box-shadow:0 0 15px #f1c40f;"></div>'})
        }).addTo(map);

        let heatLayer = L.heatLayer([], {radius: 30, blur: 20, max: 1.0}).addTo(map);
        let knownCount = 0;

        function addLog(msg, isAlert = false) {
            const div = document.createElement('div');
            div.className = 'log-entry';
            if(isAlert) div.style.borderLeftColor = '#ff4d4d';
            div.innerHTML = `<span style="color:#555">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            document.getElementById('log-container').prepend(div);
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(new SpeechSynthesisUtterance(text));
        }

        async function initiateNavigation() {
            const dest = document.getElementById('dest').value;
            if(!dest) return;
            addLog(`Requesting reroute to ${dest}...`);
            
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${dest}, Pune`);
            const data = await res.json();
            if(data.length > 0) {
                const target = [data[0].lat, data[0].lon];
                map.flyTo(target, 15);
                speak(`Path confirmed to ${dest}. Avoiding high-risk sectors.`);
                L.polyline([userCar.getLatLng(), target], {color: '#00d2ff', weight: 4, dashArray: '10, 10'}).addTo(map);
            }
        }

        // V2V SYNC: Watch for Scanner.py updates
        setInterval(async () => {
            try {
                const res = await fetch('http://127.0.0.1:8000/hazards/all');
                const hazards = await res.json();
                
                const table = document.getElementById('h-table');
                table.innerHTML = '<tr><th>VEHICLE_ID</th><th>LOCATION</th><th>STATUS</th></tr>';
                
                let heatPoints = [];
                hazards.forEach((h, i) => {
                    const row = table.insertRow();
                    row.innerHTML = `<td>SCOUT-0${(i%3)+1}</td><td>${h.lat.toFixed(3)}, ${h.lon.toFixed(3)}</td><td style="color:red">CRITICAL</td>`;
                    heatPoints.push([h.lat, h.lon, 0.7]);
                });
                heatLayer.setLatLngs(heatPoints);

                if(hazards.length > knownCount) {
                    addLog(`V2V UPDATE: Vehicle A reported new hazard in Sector 4`, true);
                    speak("Alert. Road hazard detected by fleet vehicle.");
                    knownCount = hazards.length;
                }
            } catch (e) {}
        }, 2000);
    </script>
</body>
</html>